name: ai-codespark-release

on:
  release:
    types:
      - created

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: true

jobs:
  tag-check:
    runs-on: ubuntu-latest
    env:
      RELEASE_TAG: ${{ github.event.release.tag_name }}
    steps:
      - uses: actions/checkout@v6
      - name: Validate release tag format
        shell: bash
        run: |
          set -euo pipefail

          [[ -n "${RELEASE_TAG}" ]] \
            || { echo "❌ release.tag_name is empty"; exit 1; }
          [[ "${RELEASE_TAG}" =~ ^(codespark-)?v[0-9]+\.[0-9]+\.[0-9]+(-(alpha|beta)(\.[0-9]+)?)?$ ]] \
            || { echo "❌ Tag '${RELEASE_TAG}' doesn't match expected format"; exit 1; }

          tag_ver="${RELEASE_TAG#codespark-}"
          tag_ver="${tag_ver#v}"
          cargo_ver="$(grep -m1 '^version' codex-rs/Cargo.toml | sed -E 's/version *= *"([^"]+)".*/\1/')"

          if [[ "${tag_ver}" != "${cargo_ver}" ]]; then
            echo "::warning::Tag ${tag_ver} ≠ Cargo.toml ${cargo_ver}; continuing with release tag version"
          fi

          echo "✅ Release tag format valid (${RELEASE_TAG})"

  build:
    needs: tag-check
    name: Build - ${{ matrix.os }} - ${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    timeout-minutes: 60
    env:
      CARGO_PROFILE_RELEASE_LTO: ${{ contains(github.event.release.tag_name, '-alpha') && 'thin' || 'fat' }}
    defaults:
      run:
        working-directory: codex-rs
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-musl
            release_binary_name: codex-x86_64-unknown-linux-musl
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            release_binary_name: codex-x86_64-pc-windows-msvc.exe

    steps:
      - uses: actions/checkout@v6

      - name: Install Linux build dependencies
        if: ${{ runner.os == 'Linux' }}
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends pkg-config libcap-dev

      - name: Install UBSan runtime (musl)
        if: ${{ matrix.target == 'x86_64-unknown-linux-musl' }}
        shell: bash
        run: |
          set -euo pipefail
          if command -v apt-get >/dev/null 2>&1; then
            sudo apt-get update -y
            sudo DEBIAN_FRONTEND=noninteractive apt-get install -y libubsan1
          fi

      - uses: dtolnay/rust-toolchain@1.93.0
        with:
          targets: ${{ matrix.target }}

      - name: Use hermetic Cargo home (musl)
        if: ${{ matrix.target == 'x86_64-unknown-linux-musl' }}
        shell: bash
        run: |
          set -euo pipefail
          cargo_home="${GITHUB_WORKSPACE}/.cargo-home"
          mkdir -p "${cargo_home}/bin"
          echo "CARGO_HOME=${cargo_home}" >> "$GITHUB_ENV"
          echo "${cargo_home}/bin" >> "$GITHUB_PATH"
          : > "${cargo_home}/config.toml"

      - name: Install Zig (musl)
        if: ${{ matrix.target == 'x86_64-unknown-linux-musl' }}
        uses: mlugg/setup-zig@v2
        with:
          version: 0.14.0

      - name: Install musl build tools
        if: ${{ matrix.target == 'x86_64-unknown-linux-musl' }}
        shell: bash
        env:
          TARGET: ${{ matrix.target }}
        run: bash "${GITHUB_WORKSPACE}/.github/scripts/install-musl-build-tools.sh"

      - name: Configure rustc UBSan wrapper (musl host)
        if: ${{ matrix.target == 'x86_64-unknown-linux-musl' }}
        shell: bash
        run: |
          set -euo pipefail
          ubsan=""
          if command -v ldconfig >/dev/null 2>&1; then
            ubsan="$(ldconfig -p | grep -m1 'libubsan\.so\.1' | sed -E 's/.*=> (.*)$/\1/')"
          fi
          if [[ -z "${ubsan}" ]]; then
            ubsan="$(find /usr/lib /lib -type f -name 'libubsan.so.1' 2>/dev/null | head -n1 || true)"
          fi
          if [[ -z "${ubsan}" ]]; then
            echo "::warning::libubsan.so.1 not found; musl proc-macro loading may fail"
          else
            echo "Using libubsan at: ${ubsan}"
          fi
          wrapper_root="${RUNNER_TEMP:-/tmp}"
          wrapper="${wrapper_root}/rustc-ubsan-wrapper"
          cat > "${wrapper}" <<EOF
          #!/usr/bin/env bash
          set -euo pipefail
          if [[ -n "${ubsan}" ]]; then
            export LD_PRELOAD="${ubsan}\${LD_PRELOAD:+:\${LD_PRELOAD}}"
          fi
          exec "\$1" "\${@:2}"
          EOF
          chmod +x "${wrapper}"
          echo "UBSAN_LIB=${ubsan}" >> "$GITHUB_ENV"
          echo "RUSTC_WRAPPER=${wrapper}" >> "$GITHUB_ENV"
          echo "RUSTC_WORKSPACE_WRAPPER=" >> "$GITHUB_ENV"

      - name: Clear sanitizer flags (musl)
        if: ${{ matrix.target == 'x86_64-unknown-linux-musl' }}
        shell: bash
        run: |
          set -euo pipefail
          echo "RUSTFLAGS=" >> "$GITHUB_ENV"
          echo "CARGO_ENCODED_RUSTFLAGS=" >> "$GITHUB_ENV"
          echo "RUSTDOCFLAGS=" >> "$GITHUB_ENV"
          echo "CARGO_BUILD_RUSTFLAGS=" >> "$GITHUB_ENV"
          echo "CARGO_TARGET_X86_64_UNKNOWN_LINUX_GNU_RUSTFLAGS=" >> "$GITHUB_ENV"
          echo "CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_RUSTFLAGS=" >> "$GITHUB_ENV"
          echo "CARGO_TARGET_X86_64_UNKNOWN_LINUX_MUSL_RUSTFLAGS=" >> "$GITHUB_ENV"
          echo "CARGO_TARGET_AARCH64_UNKNOWN_LINUX_MUSL_RUSTFLAGS=" >> "$GITHUB_ENV"

          sanitize_flags() {
            local input="$1"
            input="${input//-fsanitize=undefined/}"
            input="${input//-fno-sanitize-recover=undefined/}"
            input="${input//-fno-sanitize-trap=undefined/}"
            echo "$input"
          }

          cflags="$(sanitize_flags "${CFLAGS-}")"
          cxxflags="$(sanitize_flags "${CXXFLAGS-}")"
          echo "CFLAGS=${cflags}" >> "$GITHUB_ENV"
          echo "CXXFLAGS=${cxxflags}" >> "$GITHUB_ENV"

      - name: Cargo build
        shell: bash
        run: |
          set -euo pipefail
          if [[ "${{ matrix.target }}" == "x86_64-unknown-linux-musl" && -n "${UBSAN_LIB:-}" ]]; then
            export LD_PRELOAD="${UBSAN_LIB}${LD_PRELOAD:+:${LD_PRELOAD}}"
          fi
          cargo build --target ${{ matrix.target }} --release --timings --bin codex

      - name: Stage artifacts (Linux)
        if: ${{ runner.os == 'Linux' }}
        shell: bash
        run: |
          set -euo pipefail
          dest="dist/${{ matrix.target }}"
          mkdir -p "$dest"

          cp target/${{ matrix.target }}/release/codex "$dest/${{ matrix.release_binary_name }}"

      - name: Stage artifacts (Windows)
        if: ${{ runner.os == 'Windows' }}
        shell: bash
        run: |
          set -euo pipefail
          dest="dist/${{ matrix.target }}"
          mkdir -p "$dest"

          cp target/${{ matrix.target }}/release/codex.exe "$dest/${{ matrix.release_binary_name }}"

      - name: Compress artifacts (Linux)
        if: ${{ runner.os == 'Linux' }}
        shell: bash
        run: |
          set -euo pipefail
          dest="dist/${{ matrix.target }}"
          for f in "$dest"/*; do
            base="$(basename "$f")"
            tar -C "$dest" -czf "$dest/${base}.tar.gz" "$base"
            zstd -T0 -19 --rm "$dest/$base"
          done

      - name: Compress artifacts (Windows)
        if: ${{ runner.os == 'Windows' }}
        shell: bash
        run: |
          set -euo pipefail
          dest="dist/${{ matrix.target }}"
          for f in "$dest"/*; do
            base="$(basename "$f")"
            tar -C "$dest" -czf "$dest/${base}.tar.gz" "$base"
            (cd "$dest" && 7z a "${base}.zip" "$base")
          done

      - name: Upload artifacts
        uses: actions/upload-artifact@v6
        with:
          name: ${{ matrix.release_binary_name }}
          path: codex-rs/dist/${{ matrix.target }}/*

  release:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      RELEASE_TAG: ${{ github.event.release.tag_name }}
      GH_TOKEN: ${{ secrets.AI_CODESPARK_TOKEN }}
      GITHUB_TOKEN: ${{ secrets.AI_CODESPARK_TOKEN }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Generate release notes from tag commit message
        id: release_notes
        shell: bash
        run: |
          set -euo pipefail
          commit="$(git rev-parse "${RELEASE_TAG}^{commit}")"
          notes_path="${RUNNER_TEMP}/release-notes.md"
          git log -1 --format=%B "${commit}" > "${notes_path}"
          echo >> "${notes_path}"
          echo "path=${notes_path}" >> "${GITHUB_OUTPUT}"

      - uses: actions/download-artifact@v7
        with:
          path: dist

      - name: Define release name
        id: release_name
        shell: bash
        run: |
          set -euo pipefail
          version="${RELEASE_TAG#codespark-}"
          version="${version#v}"
          echo "name=${version}" >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          token: ${{ secrets.AI_CODESPARK_TOKEN }}
          name: ${{ steps.release_name.outputs.name }}
          tag_name: ${{ github.event.release.tag_name }}
          body_path: ${{ steps.release_notes.outputs.path }}
          files: dist/**
          prerelease: ${{ contains(steps.release_name.outputs.name, '-') }}
